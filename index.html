<script>
const FEED_URL = "https://media.fapple.org/feed.json";
const feed = document.getElementById("feed");

function escapeHtml(s) {
  return String(s ?? "").replace(/[&<>"']/g, (c) => ({
    "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
  }[c]));
}

function createCard(item){
  const card = document.createElement("section");
  card.className = "card";

  card.innerHTML = `
    <video playsinline muted loop preload="metadata" src="${item.src}"></video>

    <div class="meta">
      <div>${escapeHtml(item.creator || "@fapple")}</div>
      <div>${escapeHtml(item.caption || "")}</div>
    </div>

    <div class="rail">
      <div class="bubble likeBtn">â™¥</div>
      <div class="bubble">ðŸ’¬</div>
      <div class="bubble">â†—</div>
    </div>

    <div class="tapHint show" style="opacity:1; top:72px;">Tap to start</div>
  `;

  // If video fails to load, show it
  const vid = card.querySelector("video");
  vid.addEventListener("error", () => {
    console.error("Video load error:", item.src, vid.error);
  });

  return card;
}

async function loadFeed(){
  const res = await fetch(FEED_URL, { cache:"no-store" });
  if (!res.ok) throw new Error("feed fetch failed " + res.status);
  const data = await res.json();
  const items = Array.isArray(data.items) ? data.items : [];

  feed.innerHTML = "";
  items.forEach(item => feed.appendChild(createCard(item)));

  setupBehavior();
}

function setupBehavior(){
  const cards = Array.from(document.querySelectorAll(".card"));

  // Click/tap starts playback (required on some browsers)
  cards.forEach(card => {
    const vid = card.querySelector("video");
    const hint = card.querySelector(".tapHint");

    card.addEventListener("click", async (e) => {
      if (e.target.closest(".rail")) return;
      try {
        if (vid.paused) {
          await vid.play();
          hint && (hint.style.opacity = "0");
        } else {
          vid.pause();
          hint && (hint.style.opacity = "1");
        }
      } catch (err) {
        console.error("play blocked:", err);
        hint && (hint.textContent = "Tap again (play blocked)");
        hint && (hint.style.opacity = "1");
      }
    });
  });

  // IntersectionObserver: try autoplay when visible, but don't rely on it
  const io = new IntersectionObserver((entries) => {
    entries.forEach(async entry => {
      const card = entry.target;
      const vid = card.querySelector("video");
      const hint = card.querySelector(".tapHint");
      if (!vid) return;

      if (entry.isIntersecting && entry.intersectionRatio >= 0.6) {
        try {
          await vid.play();
          hint && (hint.style.opacity = "0");
        } catch {
          // Autoplay blocked is OK; user tap will start it.
          hint && (hint.style.opacity = "1");
        }
      } else {
        vid.pause();
      }
    });
  }, { threshold: [0.6] });

  cards.forEach(c => io.observe(c));
}

loadFeed().catch(err => {
  console.error(err);
  alert("Feed loaded but UI error. Open DevTools Console.");
});
</script>
